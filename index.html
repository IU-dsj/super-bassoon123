<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <title>拔河服装签收表-Word 版自由签名</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <style>
    body{margin:0;font-family:Arial;background:#f5f5f5}
    #page{display:block;margin:0 auto;background:#fff;border:1px solid #ccc}
    #btnBox{text-align:center;padding:10px}
    .btn{padding:10px 20px;font-size:16px}
    /* 弹窗 */
    #modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:none;flex-direction:column;z-index:9999}
    #popCvs{flex:1;background:#fff;touch-action:none}
    #popBar{background:#222;color:#fff;display:flex;justify-content:space-between;align-items:center;padding:8px}
    #popBar button{margin:0 4px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>
  <canvas id="page"></canvas>
  <div id="btnBox">
    <button class="btn" onclick="sendAll()">全部完成并发送</button>
  </div>

  <!-- 弹窗 -->
  <div id="modal">
    <div id="popBar">
      <span>签名</span>
      <button onclick="closePop()">✕</button>
    </div>
    <canvas id="popCvs"></canvas>
    <div id="popBar">
      <button onclick="popClear()">清空</button>
      <button onclick="popUndo()">撤销</button>
      <button onclick="finishSign()">完成</button>
    </div>
  </div>

  <script>
    /* ========== 1. 基础配置 ========== */
    const names = ['张三','李四','王二','麻子','','','','','','','','','']; // 13 人
    const toEmail = '2258559275@qq.com';

    /* ========== 2. 画布尺寸（A4 210×297 mm → 794×1123 px @96dpi） ========== */
    const vw = Math.min(window.innerWidth - 20, 794);
    const vh = vw * 1.4142; // A4 高
    const page = document.getElementById('page');
    page.width  = vw;
    page.height = vh;
    const ctx = page.getContext('2d');
    const scale = vw / 794; // 缩放因子
    const signImg = Array(names.length).fill(null); // 每格签名

    /* 表格坐标（按 Word 实际像素）*/
    const rowH = 60 * scale, headH = 40 * scale;
    const colW = [80*scale, 200*scale, 260*scale, 260*scale];
    const startX = 0;
    const startY = 50 * scale;
    const signCol = 2; // “签收人”列索引

    /* ========== 3. 绘制完整 A4 表格 ========== */
    function drawPage(){
      ctx.clearRect(0,0,page.width,page.height);
      ctx.fillStyle='#000';
      ctx.font = `${24*scale}px SimSun`;
      ctx.fillText('拔河比赛服装签收表', page.width/2 - 100*scale, 30*scale);

      // 表头
      ['序号','姓名','签收人','备注'].forEach((h,i)=>{
        const x = colW.slice(0,i).reduce((a,b)=>a+b,0);
        ctx.strokeRect(x, startY, colW[i], headH);
        ctx.fillText(h, x+5*scale, startY+headH/2+5*scale);
      });
      // 13 行
      for(let r=0;r<names.length;r++){
        const y = startY + headH + r*rowH;
        // 序号
        ctx.strokeRect(0, y, colW[0], rowH);
        ctx.fillText(String(r+1), 5*scale, y+rowH/2+5*scale);
        // 姓名
        ctx.strokeRect(colW[0], y, colW[1], rowH);
        ctx.fillText(names[r]||'', colW[0]+5*scale, y+rowH/2+5*scale);
        // 签收人栏
        const sx = colW.slice(0,signCol).reduce((a,b)=>a+b,0);
        const sw = colW[signCol], sh = rowH;
        ctx.strokeRect(sx, y, sw, sh);
        if(signImg[r]){
          ctx.drawImage(signImg[r], sx, y, sw, sh);
        }else{
          ctx.fillStyle='#aaa';
          ctx.fillText('点击签名', sx+5*scale, y+rowH/2+5*scale);
          ctx.fillStyle='#000';
        }
        // 备注
        ctx.strokeRect(sx+sw, y, colW[signCol+1], sh);
      }
    }
    drawPage();

    /* ========== 4. 点击栏打开弹窗 ========== */
    page.addEventListener('click', ev=>{
      const rect = page.getBoundingClientRect();
      const px = (ev.clientX - rect.left) / scale;
      const py = (ev.clientY - rect.top)  / scale;
      for(let r=0;r<names.length;r++){
        const y = startY + headH + r*rowH;
        const sx = colW.slice(0,signCol).reduce((a,b)=>a+b,0);
        if(px>=sx && px<=sx+colW[signCol] && py>=y && py<=y+rowH){
          openPop(r);break;
        }
      }
    });

    /* ========== 5. 弹窗签名 ========== */
    const modal = document.getElementById('modal');
    const popCvs = document.getElementById('popCvs');
    const popCtx = popCvs.getContext('2d');
    let curRow = null, paths = [];

    function openPop(r){
      curRow = r;
      modal.style.display='flex';
      popCvs.width  = window.innerWidth;
      popCvs.height = window.innerHeight - 110;
      popCtx.lineWidth = 4;
      popCtx.lineCap = popCtx.lineJoin = 'round';
      popCtx.strokeStyle = '#000';
      popCtx.clearRect(0,0,popCvs.width,popCvs.height);
      paths = [];
    }
    function closePop(){modal.style.display='none';}
    function popClear(){popCtx.clearRect(0,0,popCvs.width,popCvs.height);paths=[];}
    function popUndo(){
      paths.pop();
      popCtx.clearRect(0,0,popCvs.width,popCvs.height);
      paths.forEach(p=>{
        popCtx.beginPath();popCtx.moveTo(...p[0]);p.slice(1).forEach(pt=>popCtx.lineTo(...pt));popCtx.stroke();
      });
    }
    function finishSign(){
      const temp = document.createElement('canvas');
      temp.width  = colW[signCol];
      temp.height = rowH;
      temp.getContext('2d').drawImage(popCvs,0,0,popCvs.width,popCvs.height,0,0,temp.width,temp.height);
      signImg[curRow] = temp;
      closePop();
      drawPage();
    }

    /* 统一鼠标+触摸 */
    ['mousedown','touchstart'].forEach(evt=>popCvs.addEventListener(evt,ev=>{
      ev.preventDefault();
      paths.push([getPosPop(ev)]);
    }));
    ['mousemove','touchmove'].forEach(evt=>popCvs.addEventListener(evt,ev=>{
      if(!paths.length) return;
      ev.preventDefault();
      paths[paths.length-1].push(getPosPop(ev));
      popCtx.beginPath();
      popCtx.moveTo(...paths[paths.length-1][paths[paths.length-1].length-2]);
      popCtx.lineTo(...getPosPop(ev));
      popCtx.stroke();
    }));
    ['mouseup','touchend'].forEach(evt=>window.addEventListener(evt,()=>{}));

    function getPosPop(ev){
      const rect = popCvs.getBoundingClientRect();
      return [ev.clientX-rect.left,ev.clientY-rect.top];
    }

    /* ========== 6. 一键发送整张 A4 ========== */
    function sendAll(){
      const img = page.toDataURL('image/png');
      emailjs.init("GzWnI9_DZ731pr1NO");
      emailjs.send("service_ie5vkns", "template_0nerq9o", {
        date: new Date().toLocaleString(),
        image: img
      }).then(()=>alert("完整 A4 签到表已发送到邮箱！"))
        .catch(err=>alert("发送失败："+err));
    }
  </script>
</body>
</html>
