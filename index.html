<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <title>手机签到签名</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <style>
    body{margin:0;font-family:Arial}
    canvas{border:1px solid #ccc;background:#fff}
    .info{padding:10px;font-size:16px}
    button{padding:10px 20px;margin:4px;font-size:16px}
    #modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:none;flex-direction:column;z-index:9999}
    #popCanvas{flex:1;background:#fff;touch-action:none}
    #popBar{background:#222;color:#fff;display:flex;justify-content:space-between;align-items:center;padding:8px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>
  <div class="info">点击“签收人”栏即可签名，全部完成后发送</div>
  <canvas id="mainCvs" width="800" height="1100"></canvas>
  <button onclick="sendAll()">全部完成并发送</button>

  <!-- 弹窗 -->
  <div id="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;background:#222;color:#fff;padding:8px">
      <span>签名</span>
      <button onclick="closePop()">✕</button>
    </div>
    <canvas id="popCvs"></canvas>
    <div style="display:flex;justify-content:center;gap:10px;background:#222;padding:8px">
      <button onclick="popClear()">清空</button>
      <button onclick="popUndo()">撤销</button>
      <button onclick="finishSign()">完成</button>
    </div>
  </div>

  <script>
    /* ========== 配置 ========== */
    const names = ['张三','李四','王二','麻子','','','','','','','','',''];
    const COL_X = 330, COL_W = 260, ROW_H = 80, START_Y = 120;
    const signData = Array(names.length).fill(null);

    /* ========== 主画布 ========== */
    const mainCvs = document.getElementById('mainCvs');
    const mainCtx = mainCvs.getContext('2d');
    function drawTable(){
      mainCtx.clearRect(0,0,mainCvs.width,mainCvs.height);
      mainCtx.font = '24px SimSun';
      mainCtx.fillText('拔河比赛服装签收表',300,60);
      const heads = ['序号','姓名','签收人','备注'];
      heads.forEach((h,i)=>{
        const x = [50,130,330,590][i];
        const w = [80,200,260,260][i];
        mainCtx.strokeRect(x,START_Y-40,w,40);
        mainCtx.fillText(h,x+10,START_Y-15);
      });
      for(let r=0;r<13;r++){
        const y = START_Y + r*ROW_H;
        // 序号
        mainCtx.strokeRect(50,y,80,ROW_H);
        mainCtx.fillText(String(r+1),60,y+50);
        // 姓名
        mainCtx.strokeRect(130,y,200,ROW_H);
        mainCtx.fillText(names[r]||'',140,y+50);
        // 签收人
        mainCtx.strokeRect(COL_X,y,COL_W,ROW_H);
        if(signData[r]){
          mainCtx.drawImage(signData[r],COL_X,y,COL_W,ROW_H);
        }else{
          mainCtx.fillStyle='#aaa';mainCtx.fillText('点击签名',COL_X+10,y+50);mainCtx.fillStyle='#000';
        }
        // 备注
        mainCtx.strokeRect(590,y,260,ROW_H);
      }
    }
    drawTable();

    /* ========== 弹窗画布 ========== */
    const modal = document.getElementById('modal');
    const popCvs = document.getElementById('popCvs');
    const popCtx = popCvs.getContext('2d');
    let curRow = null, popPaths = [];

    function openPop(r){
      curRow = r;
      modal.style.display='flex';
      popCvs.width = window.innerWidth;
      popCvs.height = window.innerHeight - 110;
      popCtx.lineWidth = 4;
      popCtx.lineCap = popCtx.lineJoin = 'round';
      popCtx.strokeStyle = '#000';
      popCtx.clearRect(0,0,popCvs.width,popCvs.height);
      popPaths = [];
    }
    function closePop(){modal.style.display='none';}
    function popClear(){popCtx.clearRect(0,0,popCvs.width,popCvs.height);popPaths=[];}
    function popUndo(){
      popPaths.pop();
      popCtx.clearRect(0,0,popCvs.width,popCvs.height);
      popPaths.forEach(p=>{popCtx.beginPath();popCtx.moveTo(...p[0]);p.forEach(pt=>popCtx.lineTo(...pt));popCtx.stroke();});
    }
    function getPos(ev){
      const rect = ev.target.getBoundingClientRect();
      return [ev.clientX-rect.left,ev.clientY-rect.top];
    }
    /* 统一处理鼠标+触摸 */
    ['mousedown','touchstart'].forEach(evt=>popCvs.addEventListener(evt,ev=>{
      ev.preventDefault();
      popPaths.push([getPos(ev)]);
    }));
    ['mousemove','touchmove'].forEach(evt=>popCvs.addEventListener(evt,ev=>{
      if(!popPaths.length) return;
      ev.preventDefault();
      popPaths[popPaths.length-1].push(getPos(ev));
      popCtx.beginPath();popCtx.moveTo(...popPaths[popPaths.length-2]||popPaths[popPaths.length-1][0]);
      popCtx.lineTo(...getPos(ev));popCtx.stroke();
    }));
    ['mouseup','touchend'].forEach(evt=>window.addEventListener(evt,()=>{}));

    /* ========== 完成回填 ========== */
    function finishSign(){
      const temp = document.createElement('canvas');
      temp.width = COL_W; temp.height = ROW_H;
      temp.getContext('2d').drawImage(popCvs,0,0,popCvs.width,popCvs.height,0,0,COL_W,ROW_H);
      signData[curRow] = temp;
      closePop();
      drawTable();
    }

    /* ========== 点击主画布打开弹窗 ========== */
    mainCvs.addEventListener('click',ev=>{
      const rect = mainCvs.getBoundingClientRect();
      const {x,y} = {x:ev.clientX-rect.left,y:ev.clientY-rect.top};
      for(let r=0;r<13;r++){
        const sy = START_Y + r*ROW_H;
        if(x>=COL_X && x<=COL_X+COL_W && y>=sy && y<=sy+ROW_H){
          openPop(r);break;
        }
      }
    });

    /* ========== 一键发送 ========== */
    function sendAll(){
      const img = mainCvs.toDataURL('image/png');
      emailjs.init("GzWnI9_DZ731pr1NO");
      emailjs.send("service_ie5vkns", "template_0nerq9o", {
        date: new Date().toLocaleString(),
        image: img
      }).then(()=>alert("完整签到表已发送！"))
        .catch(err=>alert("发送失败："+err));
    }
  </script>
</body>
</html>
